@persist Objects:table Render:table

#include "xbyte_3d_engine/graphics"
#include "xbyte_3d_engine/controls"

function void render_init( T:table ) {
    local TriangleCount = 0
    
    foreach( I:string, Obj:table = T[8, table] ) { 
        Obj["Index", number] = TriangleCount
        TriangleCount += Obj["Triangles", array]:count()
    }
    
    Render["screen", wirelink] = T[1, wirelink]
    Render["camera", table] = table( "cp" = T[2, vector], "ca" = T[3, angle], "fov" = T[4, number], "znear" = T[5, number], "zfar" = T[6, number], "res" = T[7, vector2] )
    Render["objects", table] = T[8, table]
    
    Render["view", matrix4] = identity4(), # - building an empty view matrix4
    Render["viewport", matrix4] = viewport( 0, 0, T[7, vector2]:x(), T[7, vector2]:y(), 0, 1 ), # - building viewport matrix4
    Render["project", matrix4] = perspective( T[4, number], T[7, vector2]:x() / T[7, vector2]:y(), T[5, number], T[6, number] ) # - building perspective projection matrix4
}

function wirelink render_screen() { return Render["screen", wirelink] } # - get EGP
function table render_objects() { return Render["objects", table] } # - get objects
function table render_camera() { return Render["camera", table] } # - get camera

function vector camera_pos() { return render_camera()["cp", vector] } # - get camera position
function angle camera_ang() { return render_camera()["ca", angle] } # - get camera angles
function number camera_fov() { return render_camera()["fov", number] } # - get camera fov
function vector2 camera_znear() { return render_camera()["znear", vector2] } # - get camera znear
function vector2 camera_zfar() { return render_camera()["zfar", vector2] } # - get camera zfar
function vector2 camera_res() { return render_camera()["res", vector2] } # - get camera resolution

function table obj_get( Name:string ) { return render_objects()[Name, table] } # - get object by name

function void scene_init() {
    foreach( O, Obj:table = render_objects()) {
        for( I = 1, Obj:obj_tri():count() ) {
            render_screen():poly( Obj:obj_index() + I, vec4(), vec4(), vec4(), vec4( 255 ), Obj:obj_uv()[I, string] )
        }
    }
}

function void initialize( This:table ) {
    render_init( This )
    scene_init()
}

